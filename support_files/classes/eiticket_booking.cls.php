<?phpclass clsticketBooking{	var $code;	var $date_of_booking;	var $no_of_passengers;	var $name_of_passengers;	var $other;	var $booked_by;	var $requested_by;	var $travel_mode;	var $date_of_journey;	var $source;	var $destination;	var $pnr_ticketno;	var $authorised_by;	var $mode_of_payment;	var $chequeno_ccholder;	var $printed_amount;	var $commission;	var $balance_amount;	var $travel_reason;	var $small_remark;	var $tatkal;	var $eligible_amount;	var $need_approval;	var $reason;	var $amount_checked_by;	var $cancellation_status;	var $cancelled_by;	var $refund_amount;	var $creditnote_amount;	var $creditnote_validity_date;	var $refunded_amount_checked_by;	var $claimed;	var $entered_date;	var $modify_by;	var $modifydate;	var $message;	var $actiontoperform;	var $start_submitdate;	var $end_submitdate;	var $SBOpermission;	var $used_credit_amount;	var $credit_note_code;	var $travel_mode_cn;	var $hdnCreditNoteAmount;	var $encashedDate;	var $encashedAmount;	var $encashedPaidTo;	var $encashedRemarks;	function clsticketBooking()	{		$this->code="";		$this->date_of_booking=date("Y-m-d");		$this->no_of_passengers=0;		$this->name_of_passengers="";		$this->other="";		$this->booked_by=$_SESSION['username'];		$this->requested_by=ucfirst($_SESSION['username']);		$this->travel_mode="";		$this->date_of_journey=date("Y-m-d");		$this->source="";		$this->destination="";		$this->pnr_ticketno="";		$this->authorised_by="";		$this->mode_of_payment="";		$this->chequeno_ccholder=ucfirst($_SESSION['username']);		$this->printed_amount=0;		$this->commission=0.00;		$this->balance_amount=0.00;		$this->travel_reason="";		$this->small_remark="";		$this->tatkal="N";		$this->eligible_amount="";		$this->need_approval="N";		$this->reason="";		$this->amount_checked_by="";		$this->cancellation_status="Not Cancelled";		$this->cancelled_by="";		$this->refund_amount=0;		$this->creditnote_amount=0;		$this->creditnote_validity_date="";		$this->refunded_amount_checked_by="";		$this->claimed=0;		$this->entered_date=date("Y-m-d");		$this->modify_by=$_SESSION['username'];		$this->modifydate=date("Y-m-d");		$this->message="";		$this->actiontoperform="";				$ts = time();		$one_month = 31 * 24 * 60 * 60;		$this->start_submitdate = date( "d-m-Y", ( $ts - $one_month ) );		$this->end_submitdate = date( "d-m-Y", ( $ts + $one_month ) );		$this->used_credit_amount = 0;		$this->credit_note_code = 0;		$this->travel_mode_cn = "";		$this->hdnCreditNoteAmount = "0.00";		$this->encashedDate = "0000-00-00";		$this->encashedAmount = "0.00";		$this->encashedPaidTo = "";		$this->encashedRemarks = "";	}		function setpostvars()	{		if(isset($_REQUEST["code"]))					$this->code = trim($_REQUEST["code"]);		if(isset($_REQUEST["date_of_booking"]))			$this->date_of_booking = trim($_REQUEST["date_of_booking"]);		if(isset($_REQUEST["no_of_passengers"]))		$this->no_of_passengers = trim($_REQUEST["no_of_passengers"]);		if(isset($_REQUEST["name_of_passengers"]))		$this->name_of_passengers = trim($_REQUEST["name_of_passengers"]);		if(isset($_REQUEST["other"]) && $this->name_of_passengers=="")	$this->name_of_passengers = trim($_REQUEST["other"]);		if(isset($_REQUEST["booked_by"]))				$this->booked_by = trim($_REQUEST["booked_by"]);		if(isset($_REQUEST["requested_by"]))			$this->requested_by = trim($_REQUEST["requested_by"]);		if(isset($_REQUEST["travel_mode"]))				$this->travel_mode = trim($_REQUEST["travel_mode"]);		if(isset($_REQUEST["date_of_journey"]))			$this->date_of_journey = trim($_REQUEST["date_of_journey"]);		if(isset($_REQUEST["source"]))					$this->source = trim($_REQUEST["source"]);		if(isset($_REQUEST["destination"]))				$this->destination = trim($_REQUEST["destination"]);		if(isset($_REQUEST["pnr_ticketno"]))			$this->pnr_ticketno = trim($_REQUEST["pnr_ticketno"]);		if(isset($_REQUEST["authorised_by"]))			$this->authorised_by = trim($_REQUEST["authorised_by"]);		if(isset($_REQUEST["mode_of_payment"]))			$this->mode_of_payment = trim($_REQUEST["mode_of_payment"]);		if(isset($_REQUEST["chequeno_ccholder"]))		$this->chequeno_ccholder = trim($_REQUEST["chequeno_ccholder"]);		if(isset($_REQUEST["chequeno_ccholder2"]) && $_REQUEST["mode_of_payment"] == 'Credit Note')		$this->chequeno_ccholder = trim($_REQUEST["chequeno_ccholder2"]);		if(isset($_REQUEST["printed_amount"]))			$this->printed_amount = trim($_REQUEST["printed_amount"]);		if(isset($_REQUEST["commission"]) and ($_REQUEST["commission"] !=0.00) ) $this->commission = trim($_REQUEST["commission"]);		if(isset($_REQUEST["balance_amount"]))			$this->balance_amount = trim($_REQUEST["balance_amount"]);		if(isset($_REQUEST["travel_reason"]))			$this->travel_reason = trim($_REQUEST["travel_reason"]);		if(isset($_REQUEST["small_remark"]))			$this->small_remark = trim($_REQUEST["small_remark"]);		if(isset($_REQUEST["tatkal"]))					$this->tatkal = "Y";		if(isset($_REQUEST["eligible_amount"]))			$this->eligible_amount = trim($_REQUEST["eligible_amount"]);		if(isset($_REQUEST["need_approval"]))			$this->need_approval = "Y";		if(isset($_REQUEST["reason"]))					$this->reason = trim($_REQUEST["reason"]);		if(isset($_REQUEST["amount_checked_by"]))		$this->amount_checked_by = trim($_REQUEST["amount_checked_by"]);		if(isset($_REQUEST["cancellation_status"]))		$this->cancellation_status = trim($_REQUEST["cancellation_status"]);		if(isset($_REQUEST["cancelled_by"]))			$this->cancelled_by = trim($_REQUEST["cancelled_by"]);		if(isset($_REQUEST["refund_amount"]))			$this->refund_amount = trim($_REQUEST["refund_amount"]);		if(isset($_REQUEST["creditnote_amount"]))		$this->creditnote_amount = trim($_REQUEST["creditnote_amount"]);		if(isset($_REQUEST["creditnote_validity_date"]))	$this->creditnote_validity_date = trim($_REQUEST["creditnote_validity_date"]);		if(isset($_REQUEST["refunded_amount_checked_by"]))	$this->refunded_amount_checked_by = trim($_REQUEST["refunded_amount_checked_by"]);		if(isset($_REQUEST["claimed"]))					$this->claimed = trim($_REQUEST["claimed"]);		if(isset($_REQUEST["entered_date"]))			$this->entered_date = trim($_REQUEST["entered_date"]);		if(isset($_REQUEST["modify_by"]))				$this->modify_by = trim($_REQUEST["modify_by"]);		if(isset($_REQUEST["modifydate"]))				$this->modifydate = trim($_REQUEST["modifydate"]);		if(isset($_REQUEST["actiontoperform"]))			$this->actiontoperform = trim($_REQUEST["actiontoperform"]);		if(isset($_REQUEST["start_submitdate"]))		$this->start_submitdate = trim($_REQUEST["start_submitdate"]);		if(isset($_REQUEST["end_submitdate"]))			$this->end_submitdate = trim($_REQUEST["end_submitdate"]);		if(isset($_REQUEST["SBOpermission"]))			$this->SBOpermission = trim($_REQUEST["SBOpermission"]);		if(isset($_REQUEST["used_credit_amount"])) 		$this->used_credit_amount = $_REQUEST["used_credit_amount"];		if(isset($_REQUEST["creditnote_code"]))			$this->credit_note_code = $_REQUEST["creditnote_code"];		if(isset($_REQUEST["txthdntravel_mode"]))		$this->travel_mode_cn = $_REQUEST["txthdntravel_mode"];		if(isset($_REQUEST["txthdnCreditAmount"]))		$this->hdnCreditNoteAmount = $_REQUEST["txthdnCreditAmount"];		if(isset($_REQUEST["txtEncashDate"]))			$this->encashedDate = $_REQUEST["txtEncashDate"];		if(isset($_REQUEST["txtEncashAmount"]))			$this->encashedAmount = $_REQUEST["txtEncashAmount"];		if(isset($_REQUEST["txtEncashPaidTo"]))			$this->encashedPaidTo = $_REQUEST["txtEncashPaidTo"];		if(isset($_REQUEST["txtEncashRemarks"]))		$this->encashedRemarks = $_REQUEST["txtEncashRemarks"];			}		function addTicket(){									/*$ins_query =  "INSERT INTO 						ticket_details 						SET 						date_of_booking = '" .formatDate($this->date_of_booking)."',						no_of_passengers = " .$this->no_of_passengers.",						name_of_passengers = '" .$this->name_of_passengers."',						booked_by = '" .$this->booked_by."',						requested_by = '" .$this->requested_by."',						travel_mode = '" .$this->travel_mode."',						date_of_journey = '" .formatDate($this->date_of_journey)."',						source = '" .$this->source."',						destination = '" .$this->destination."',						pnr_ticketno = '" .$this->pnr_ticketno."',						authorised_by = '" .$this->authorised_by."',						mode_of_payment = '" .$this->mode_of_payment."',						chequeno_ccholder = '" .$this->chequeno_ccholder."',						printed_amount = '" .$this->printed_amount."',						commission = " .$this->commission.",						balance_amount = ".$this->balance_amount.",						travel_reason = '" .$this->travel_reason."',						small_remark = '" .$this->small_remark."',						tatkal = '" .$this->tatkal."',						eligible_amount = '" .$this->eligible_amount."',						need_approval = '" .$this->need_approval."',						reason = '" .$this->reason."',						cancellation_status = '" .$this->cancellation_status."',						entered_date = NOW(),						SBOpermission = '" .$this->SBOpermission."'						  ";*/			$ins_query =  "INSERT INTO ticket_details(date_of_booking,no_of_passengers,name_of_passengers,booked_by,requested_by,travel_mode,			date_of_journey,source,destination,pnr_ticketno,authorised_by,mode_of_payment,chequeno_ccholder,printed_amount,commission,			balance_amount,travel_reason,small_remark,tatkal,eligible_amount,need_approval,reason,cancellation_status,entered_date,SBOpermission) values 						  ('" .formatDate($this->date_of_booking)."'," .$this->no_of_passengers.", '" .$this->name_of_passengers."', '" .$this->booked_by."',						  '".$this->requested_by."','".$this->travel_mode."','" .formatDate($this->date_of_journey)."','".$this->source."',						  '".$this->destination."','" .$this->pnr_ticketno."','" .$this->authorised_by."','" .$this->mode_of_payment."',						  '" .$this->chequeno_ccholder."'," .$this->printed_amount.", " .$this->commission.",".$this->balance_amount.",'".$this->travel_reason."',						   '".$this->small_remark."','".$this->tatkal."','".$this->eligible_amount."','".$this->need_approval."','".$this->reason."','".$this->cancellation_status."','".$this->entered_date."','".$this->SBOpermission."')";						 			 //echo $ins_query;			mysql_query($ins_query) or die("#$ins_query#".mysql_error());			$this->taskCode = mysql_insert_id();			$ticket_id = mysql_insert_id();            $this->setCreditNoteUsage($ticket_id);			$this->message = "Inserted successfully...Your Ticket Code is: ".$this->code;							echo "<script>opener.history.go(0);window.close();</script>";	}		function updateTicket(){				$update_query = "UPDATE ticket_details SET date_of_booking='".formatDate($this->date_of_booking)."',no_of_passengers=" .$this->no_of_passengers.",			name_of_passengers='" .$this->name_of_passengers."',booked_by='" .$this->booked_by."',requested_by='".$this->requested_by."',travel_mode='".$this->travel_mode."',			date_of_journey='" .formatDate($this->date_of_journey)."',source='" .$this->source."',destination='" .$this->destination."',pnr_ticketno='" .$this->pnr_ticketno."',			mode_of_payment='" .$this->mode_of_payment."',chequeno_ccholder='" .$this->chequeno_ccholder."',printed_amount=" .$this->printed_amount.",			commission=" .$this->commission.",balance_amount=" .$this->balance_amount.",travel_reason='".$this->travel_reason."',			small_remark='".$this->small_remark."',tatkal='".$this->tatkal."',eligible_amount='".$this->eligible_amount."',need_approval='".$this->need_approval."',			reason='".$this->reason."',modify_by='".$this->modify_by."',SBOpermission = '".$this->SBOpermission."' WHERE code=".$this->code;						//echo $update_query;			mysql_query($update_query) or die(mysql_error());			$this->editCreditNoteUsage($this->code);			$this->message = "Ticket Code ".$this->code." Updated successfully...";								echo "<script>opener.history.go(0);window.close();</script>";		}		function deleteTicket(){				$this->addVersion();		 				/* Realise a used CN payment before booked ticket going to delete */		$queryCreditNote = "SELECT ticketCreditNote,amount FROM ticket_creditnote_details WHERE ticketCode=".$this->code;		$resultCreditNote = mysql_query($queryCreditNote) or die("#$queryCreditNote#".mysql_error());		$NumRow_CreditNoteTics = mysql_num_rows($resultCreditNote);		if($NumRow_CreditNoteTics)		{ 			while($rowCreditNote = mysql_fetch_array($resultCreditNote))			{				$queryUpdate = "UPDATE ticket_details SET creditnote_amount = (creditnote_amount + ".$rowCreditNote["amount"].") WHERE code =  '".$rowCreditNote["ticketCreditNote"]."' LIMIT 1";				mysql_query($queryUpdate) or die("#$queryUpdate#".mysql_error());			}		}				$deleteCreditNoteAsc = "DELETE FROM ticket_creditnote_details WHERE ticketCode=".$this->code;		mysql_query($deleteCreditNoteAsc) or die("#$deleteCreditNoteAsc#".mysql_error());				$delete_query = "DELETE FROM ticket_details WHERE code=".$this->code;				 //echo $delete_query;		mysql_query($delete_query) or die("#$delete_query#".mysql_error());				$this->message = "Ticket Code ".$this->code." Deleted successfully...";						echo "<script>opener.history.go(0);window.close();</script>";	}		function addVersion(){				$insert_query = "INSERT INTO junk_ticket_details SELECT * FROM ticket_details where code=".$this->code;		mysql_query($insert_query) or die("$insert_query".mysql_error());			}		function populateDetails($taskID)	{		$query = "SELECT * FROM ticket_details WHERE code=".$this->code;		//echo $query;		$result = mysql_query($query);		$line = mysql_fetch_array($result);		$this->taskCode				= $this->code;		$this->date_of_booking		= $line['date_of_booking'];		$this->no_of_passengers		= $line['no_of_passengers'];		$this->name_of_passengers	= $line['name_of_passengers'];		$this->booked_by			= $line['booked_by'];		$this->requested_by			= $line['requested_by'];		$this->travel_mode			= $line['travel_mode'];		$this->date_of_journey		= $line['date_of_journey'];		$this->source				= $line['source'];		$this->destination			= $line['destination'];		$this->pnr_ticketno			= $line['pnr_ticketno'];		$this->authorised_by		= $line['authorised_by'];		$this->mode_of_payment		= $line['mode_of_payment'];		$this->chequeno_ccholder	= $line['chequeno_ccholder'];		$this->printed_amount		= $line['printed_amount'];		$this->commission			= $line['commission'];		$this->balance_amount		= $line['balance_amount'];		$this->travel_reason		= $line['travel_reason'];		$this->small_remark			= $line['small_remark'];		$this->tatkal				= $line['tatkal'];		$this->eligible_amount		= $line['eligible_amount'];		$this->need_approval		= $line['need_approval'];		$this->reason				= $line['reason'];		$this->amount_checked_by	= $line['amount_checked_by'];		$this->cancellation_status	= $line['cancellation_status'];		$this->cancelled_by			= $line['cancelled_by'];		$this->refund_amount		= $line['refund_amount'];		$this->creditnote_amount	= $line['creditnote_amount'];		$this->creditnote_validity_date	= $line['creditnote_validity_date'];		$this->refunded_amount_checked_by= $line['refunded_amount_checked_by'];		$this->claimed				= $line['claimed'];		$this->entered_date			= $line['entered_date'];		$this->modify_by			= $line['modify_by'];		$this->modifydate			= $line['modifydate'];		$this->SBOpermission			= $line['SBOpermission'];	}	function setCreditNoteUsage($ticket_code)	{		if(is_array($this->used_credit_amount) && count($this->used_credit_amount) >0)		{			foreach($this->used_credit_amount as $key => $value)			{				if($key != '' && $value != '' && $ticket_code != '' && $this->travel_mode == $this->travel_mode_cn[$key])				{					$value = $value + 0.00;					$queryIns = "INSERT INTO ticket_creditnote_details 					SET 					ticketCode = '".$ticket_code."',					ticketCreditNote = '".$key."',					amount = '".$value."',					status = 'ACTIVE' ";					$resultIns = mysql_query($queryIns) or die( " $queryIns ".mysql_error());					$queryUpdate = "UPDATE ticket_details SET creditnote_amount = (creditnote_amount-".$value."),modify_by='".$_SESSION["username"]."' WHERE code=".$key." LIMIT 1";					$resultUpdate = mysql_query($queryUpdate) or die("While Setting Credit note amount ".mysql_error());				}			}		}	}	function editCreditNoteUsage($ticket_code)	{		if(is_array($this->used_credit_amount) && count($this->used_credit_amount) >0)		{			foreach($this->used_credit_amount as $key => $value)			{				if($key != '' && $value != '' && $ticket_code != '' && $this->travel_mode == $this->travel_mode_cn[$key])				{					$query2 = "SELECT amount FROM ticket_creditnote_details WHERE ticketCode = '".$ticket_code."' AND ticketCreditNote = '".$key."'";					$result2 = mysql_query($query2) or die(mysql_error());					$row2 = mysql_fetch_array($result2);					$amountTotal = $row2["amount"] + $this->hdnCreditNoteAmount[$key];					if($value <= $amountTotal)					{						$difference = $amountTotal - $value;						$queryUpdate = "UPDATE ticket_details SET creditnote_amount = '".$difference."',modify_by='".$_SESSION["username"]."' WHERE code=".$key." LIMIT 1";						$resultUpdate = mysql_query($queryUpdate) or die("While Setting Credit note amount ".mysql_error());						}					$queryIns = "REPLACE INTO ticket_creditnote_details SET ticketCode = '".$ticket_code."',ticketCreditNote = '".$key."',amount = '".$value."'";					$resultIns = mysql_query($queryIns) or die( " $queryIns ".mysql_error());										/*$value = $value + 0.00;					$queryIns = "INSERT INTO ticket_creditnote_details SET ticketCode = '".$ticket_code."',ticketCreditNote = '".$key."',amount = '".$value."'";					$resultIns = mysql_query($queryIns) or die( " $queryIns ".mysql_error());										$queryUpdate = "UPDATE ticket_details SET creditnote_amount = (creditnote_amount-".$value."),modify_by='".$_SESSION["username"]."' WHERE code=".$key." LIMIT 1";					$resultUpdate = mysql_query($queryUpdate) or die("While Setting Credit note amount ".mysql_error());*/				}			}		}			}	function getCreditNoteUsageDetails($ticket_code)	{		$arrRet = array();		$query = "SELECT * FROM ticket_creditnote_details WHERE ticketCode = '".$ticket_code."'";		$result = mysql_query($query) or die(mysql_error());		while($row = mysql_fetch_array($result))		{			$arrRet[$row["ticketCreditNote"]] = array("ticketCreditNote"=>$row["ticketCreditNote"],														"amount"=>$row["amount"]);					}		return $arrRet;	}	function setCreditNoteAsEncashed()	{		$this->setpostvars();		$query = "UPDATE ticket_details SET creditnote_amount =  creditnote_amount - ".$this->encashedAmount.",encashed_amount = encashed_amount +  ".$this->encashedAmount.",encashed_remarks = CONCAT_WS('|',encashed_remarks,'".date("Y-m-d").";".$this->encashedRemarks."'),encashed_to = CONCAT_WS('|',encashed_to,'".$this->encashedPaidTo."'),encashed_date = CONCAT_WS('|',encashed_date,'".$this->encashedDate."')  WHERE code = '".$this->code."' LIMIT 1";			$result = mysql_query($query) or die(mysql_error());	}}?>